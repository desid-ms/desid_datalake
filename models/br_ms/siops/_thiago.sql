MODEL (
    name siops.thiago,
    kind FULL
);

WITH 
-- contas operacionais são contas que representam entradas de dados
-- contas agregadoras são contas que agregam valores de contas operacionais (totalizadoras)
contas_operacionais AS (
    SELECT UNNEST([
        16,17,19,20,23,29,30,34,35,36,37,38,39,42,44,45,46,47,48,49,50,51,52,53,
        54,55,56,57,58,59,60,61,62,65,67,69,73,74,75,76,77,78,79,80,81,82,83,85,
        86,87,90,91,92,93,95,96,97,98,99,100,101,102,108,109,110,111,114,116,117,
        121,122,124,125,126,127,128,129,130,132,133,134,135,136,138,139,143,146,
        147,148,149,150,151,153,154,155,156,157,158,159,160,161,163,164,165,166,
        167,168,169,170,171,173,174,175,177,178,179,181,182,183,184,186,187,188,
        191,192,194,195,196,198,199,200,202,203,204,205,206,207,211,213,214,215,
        216,217,221,223,224,225,227,228,229,230,235,236,238,239,240,241,242,244,
        246,247,250,251,252,253,258,259,260,262,263,264,265,266,267,272,273,274,
        275,276,279,280,281,282,283,284,285,291,292,293,294,295,296,297,298,299,
        300,301,303,304,305,306,307,309,310,311,312,313,315,316,317,318,320,321,
        322,323,325,326,327,328,329,332,333,335,336,337,339,340,341,342,344,345,
        346,347,348,349,350,706,707,711,714,715,716,717,720,721,722,723,724,725,
        726,727,728,729,730,731,732,733,734,735,736,737,738,739,740,741,742,745,
        746,748,749,751,752,753,754,
        1633,1634,1638,1639,1640,1641,1642,1643,1644,1645,1647,1648,1649,1650,
        1651,1652,1653,1654,1657,1658,1659,1660,1661,1662,1663,1664,1666,1667,
        1668,1669,1670,1671,1672,1673,1674,1675,1677,1678,1681,1682,1683,1684,
        1685,1687,1688,1689,1690,1692,1695,1696,1697,1698,1699,1700,1701,1702,
        1703,1704,1706,1707,1708,1709,1710,1711,1712,1713,1714,1715,1716,1717,
        1719,1720,1723,1725,1726,1729,1730,1731,1732,1733,1734,1735,1738,1741,
        1742,1743,1744,1745,1746,1748,1749,1750,1751,1752,1753,1754,1756,1757,
        1758,1759,1760,1761,1763,1764,1765,1766,1767,1768,1769,1770,1771,1772,
        1774,1775,1776,1777,1778,1779,1780,1781,1782,1783,1785,1788,1789,1790,
        1791,1792,1793,1795,1796,1797,1798,1799,1800,1801,1803,1804,1805,1806,
        1808,1810,1811,1813,1814,1815,1816,1818,1821,1822,1823,1824,1826,1829,
        1830,1832,1835,1836,1837,1839,1842,1843,1844,1845,1847,1849,1850,1851,
        1853,1854,1855,1856,1858,1859,1860,1861,1862,1863,1864,1865,1866,1867,
        1868,1869,1870,1871,1872,1876,1877,1878,1881,1882,1883,1884,1885,1886,
        1887,1888,1890,1891,1894,1895,1896,1897,1898,1899,1900,1902,1903,1904,
        1905,1908,1911,1913,1914,1915,1916,1917,1918,1920,1921,1922,1923,1924,
        1925,1926,1928,1929,1930,1931,1932,1933,1934,1935,1937,1939,1940,1941,
        1943,1944,1945,1946,1947,1948,1949,1951,1953,1955,1956,1957,1958,1959,
        1961,1964,1965,1966,1968,1969,1971,1974,1975,1976,1978,1981,1982,1983,
        1984,1985,1990,1991,1995,1996,1997,1998,1999,2000,2001,2002,2004,2005,
        2006,2007,2008,2009,2010,2011,2014,2015,2016,2017,2018,2019,2020,2021,
        2023,2024,2025,2026,2027,2028,2029,2030,2031,2032,2034,2035,2038,2039,
        2040,2041,2042,2043,2044,2045,2046,2048,2049,2052,2054,2055,2058,2059,
        2060,2061,2062,2063,2064,2065,2066
    ]) AS CO_ITEM
),
-- eventos_contas agrega todas as atualizacoes feitas sobre as contas
eventos_contas AS (
    SELECT 
        ITEM.CO_SEQ_ITEM AS ID_CONTA,
        ITEM.CO_ITEM_EXIBICAO AS CONTA,
        ITEM.NO_ITEM AS NOME_CONTA,
        MAX(CASE WHEN PERFED.CO_ENTE_FEDERADO = 1 THEN 'S' ELSE 'N' END) AS ATIVO_ESTADO,
        MAX(CASE WHEN PERFED.CO_ENTE_FEDERADO = 2 THEN 'S' ELSE 'N' END) AS ATIVO_DF,
        MAX(CASE WHEN PERFED.CO_ENTE_FEDERADO = 3 THEN 'S' ELSE 'N' END) AS ATIVO_MUNICIPIO,
        'N' AS ATIVO_UNIAO,  
        (SELECT MIN(DT_DISPONIBILIZACAO) FROM RAW_SIOPSUF.TB_PROJ_ESTRUTURA_VERSAO A 
        WHERE A.DS_VERSAO = '1.0' AND A.CO_ANO_PER_ENTE_FED = PERFED.CO_ANO_PERIODO) AS DATA_ATUALIZACAO
    FROM RAW_SIOPSUF.RL_PROJ_ANOPERIODO_ENTE_FED PERFED
    JOIN RAW_SIOPSUF.RL_PROJ_ANOPERIODOENTE_PASTA PERFEDPASTA ON PERFED.CO_SEQ_ANO_PER_ENTE_FED = PERFEDPASTA.CO_ANOPERIODO_ENTE_FED
    JOIN RAW_SIOPSUF.TB_PROJ_PASTA PASTA ON PERFEDPASTA.CO_PASTA = PASTA.CO_SEQ_PASTA
    JOIN RAW_SIOPSUF.RL_PROJ_PASTA_ITEM PASTAITEM ON PERFEDPASTA.CO_SEQ_ANO_PER_ENTE_PASTA = PASTAITEM.CO_ANO_PER_ENTE_PASTA
    JOIN RAW_SIOPSUF.TB_PROJ_ITEM ITEM ON PASTAITEM.CO_ITEM = ITEM.CO_SEQ_ITEM
    WHERE PASTA.CO_SEQ_PASTA IN ('1', '2')
    GROUP BY ALL --ITEM.CO_ITEM_EXIBICAO, ITEM.NO_ITEM, PERFED.CO_ANO_PERIODO
    ORDER BY DATA_ATUALIZACAO
)
select * from eventos_contas
-- select * exclude DATA_ATUALIZACAO, first(DATA_ATUALIZACAO) AS DATA_ATUALIZACAO from siops__dev.thiago group by all order by conta, data_atualizacao;

--  SELECT * exclude(data_atualizacao), last(data_atualizacao) as ATUALIZACAO FROM eventos_contas GROUP BY ALL
-- pivot_contas AS (
--     PIVOT contas_por_periodo ON CO_ENTE_FEDERADO
--     USING LAST(co_ente_federado)
--     GROUP BY conta, nome_conta, tipo_conta, anobimestre
-- ) 

-- SELECT   * from pivot_contas order by conta, anobimestre
-- --     CONTA,  
-- --     NOME_CONTA, 
-- --     TIPO_CONTA, 
-- --     ANOBIMESTRE, 
-- --     CASE WHEN ATIVO_DF IS NULL THEN 'N' ELSE 'S' END AS ATIVO_DF, 
-- --     CASE WHEN ATIVO_ESTADO IS NULL THEN 'N' ELSE 'S' END AS ATIVO_ESTADO, 
-- --     CASE WHEN ATIVO_MUNICIPIO IS NULL THEN 'N' ELSE 'S' END AS ATIVO_MUNICIPIO 
-- -- FROM pivot_contas
-- -- ORDER BY conta, anobimestre